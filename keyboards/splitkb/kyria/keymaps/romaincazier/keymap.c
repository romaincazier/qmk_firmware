/* Copyright 2019 Thomas Baart <thomas@splitkb.com>
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
#include QMK_KEYBOARD_H

uint16_t copy_paste_timer;

enum layers {
    QWERTY = 0,
    RAISE,
    LOWER,
    NAVIGATION
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
/*
 * Base Layer: QWERTY
 *
 * ,------------------------------------------.                              ,------------------------------------------.
 * |  ESC  |   Q  |   W  |   E  |   R  |   T  |                              |  Y   |  U   |  I   |  O   |  P   | BKSP  |
 * |-------+------+------+------+------+------|                              |------+------+------+------+------+-------|
 * |  TAB  |   A  |   S  |   D  |   F  |   G  |                              |  H   |  J   |  K   |  L   | ;  : | '  "  |
 * |-------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+-------|
 * |  LSFT |   Z  |   X  |   C  |   V  |   B  | -  _ | LCTL |  | RCTL | |  \ |  N   |  M   | ,  < | .  > | /  ? | RSFT  |
 * `---------------------+------+------+------+------+------|  |------+------+------+------+------+---------------------'
 *                       | [  { | LALT | RAISE| SPCE | HYPR |  | ENTR | SPCE |LOWER | RALT | ]  } |
 *                       `----------------------------------'  `----------------------------------'
 */
    [QWERTY] = LAYOUT(
        KC_ESC , KC_Q   , KC_W   , KC_E   , KC_R   , KC_T     ,                                     KC_Y     , KC_U   , KC_I   , KC_O  , KC_P   , KC_BSPC,
        KC_TAB , KC_A   , KC_S   , KC_D   , KC_F   , KC_G     ,                                     KC_H     , KC_J   , KC_K   , KC_L  , KC_SCLN, KC_QUOT,
        KC_LSFT, KC_Z   , KC_X   , KC_C   , KC_V   , KC_B     , KC_MINS, _______, _______, KC_BSLS, KC_N     , KC_M   , KC_COMM, KC_DOT, KC_SLSH, KC_RSFT,
                                   KC_LBRC, KC_LALT, MO(RAISE), KC_SPC , KC_LGUI, KC_ENT , KC_SPC , MO(LOWER), KC_RALT, KC_RBRC
    ),
/*           
 * Top Layer: Numbers, Symbols
 *
 * ,------------------------------------------.                              ,------------------------------------------.
 * |  `  ~ | 1  ! | 2  @ | 3  # | 4  $ | 5  % |                              | 6  ^ | 7  & | 8  * | 9  ( | 0  ) | =  +  |
 * |-------+------+------+------+------+------|                              |------+------+------+------+------+-------|
 * |       |      |      |      |      |      |                              |      |      |      |      |      |       |
 * |-------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+-------|
 * |  LSFT |      |      |      |      |      |      | LCTL |  | RCTL |      |      |      |      |      |      | RSFT  |
 * `---------------------+------+------+------+------+------|  |------+------+------+------+------+---------------------'
 *                       |      | LALT | RAISE| SPCE | HYPR |  | ENTR | SPCE |LOWER | RALT |      |
 *                       `----------------------------------'  `----------------------------------'
 */
    [RAISE] = LAYOUT(
        KC_GRV , KC_1   , KC_2   , KC_3   , KC_4   , KC_5   ,                                     KC_6   , KC_7   , KC_8   , KC_9   , KC_0   , KC_EQL ,
        XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,                                     XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
        _______, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, _______, _______, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, _______,
                                   XXXXXXX, _______, _______, _______, _______, _______, _______, _______, _______, XXXXXXX
    ),
/*
 * Down Layer: French (handled by process_record_user)
 *
 * ,------------------------------------------.                              ,------------------------------------------.
 * |       |      |   È  |   É  |   Ê  |   €  |                              |      |  Ù   |  Î   |  Ï   |      |       |
 * |-------+------+------+------+------+------|                              |------+------+------+------+------+-------|
 * |       |   À  |      |      |      |      |                              |      |      |      |      |      |       |
 * |-------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+-------|
 * |  LSFT |      |      |   Ç  |      |      |      | LCTL |  | RCTL |      |      |      |  «   |  »   |      | RSFT  |
 * `---------------------+------+------+------+------+------|  |------+------+------+------+------+---------------------'
 *                       |      | LALT | RAISE| SPCE | HYPR |  | ENTR | SPCE |LOWER | RALT |      |
 *                       `----------------------------------'  `----------------------------------'
 */
    [LOWER] = LAYOUT(
        XXXXXXX, XXXXXXX, _______, _______, _______, _______,                                     XXXXXXX, _______, _______, _______, XXXXXXX, XXXXXXX,
        XXXXXXX, _______, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,                                     XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
        _______, XXXXXXX, XXXXXXX, _______, XXXXXXX, XXXXXXX, XXXXXXX, _______, _______, XXXXXXX, XXXXXXX, XXXXXXX, _______, _______, XXXXXXX, _______,
                                   XXXXXXX, _______, _______, _______, _______, _______, _______, _______, _______, XXXXXXX
    ),
/*
 * Navigation Layer
 *
 * ,------------------------------------------.                              ,------------------------------------------.
 * |       |      | LEFT |  UP  | RIGT | PGUP |                              | VOL+ | PREV | PLAY | NEXT |      | STOP  |
 * |-------+------+------+------+------+------|                              |------+------+------+------+------+-------|
 * |       |      |      | DOWN |      | PGDN |                              | VOL- |      |      |      |      |       |
 * |-------+------+------+------+------+------+-------------.  ,-------------+------+------+------+------+------+-------|
 * |  LSFT |      |      |      |      |      |      | LCTL |  | RCTL |      | MUTE |      |      |      |      | RSFT  |
 * `---------------------+------+------+------+------+------|  |------+------+------+------+------+---------------------'
 *                       |      | LALT | RAISE| SPCE | HYPR |  | ENTR | SPCE |LOWER | RALT |      |
 *                       `----------------------------------'  `----------------------------------'
 */
    [NAVIGATION] = LAYOUT(
        XXXXXXX, XXXXXXX, KC_LEFT, KC_UP  , KC_RGHT, KC_PGUP,                                     KC_VOLU, KC_MPRV, KC_MPLY, KC_MNXT, XXXXXXX, KC_MSTP,
        XXXXXXX, XXXXXXX, XXXXXXX, KC_DOWN, XXXXXXX, KC_PGDN,                                     KC_VOLD, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX,
        _______, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, _______, _______, XXXXXXX, KC_MUTE, XXXXXXX, XXXXXXX, XXXXXXX, XXXXXXX, _______,
                                   XXXXXXX, _______, _______, _______, _______, _______, _______, _______, _______, XXXXXXX
    ),
};

layer_state_t layer_state_set_user(layer_state_t state) {
    return update_tri_layer_state(state, LOWER, RAISE, NAVIGATION);
}

bool is_shift_active = false;

static bool check_and_reset_shift(void) {
    if (is_shift_active) {
        clear_mods();
        is_shift_active = false;
        return true;
    }
    return false;
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    if (get_highest_layer(layer_state) != LOWER) return true;
    if (record->event.pressed) {
        switch (keycode) {
            case KC_LSFT:
            case KC_RSFT:
                is_shift_active = true;
                break;
            case KC_A: // À
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("`") SS_DOWN(X_LSFT) SS_TAP(X_A) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("`") SS_TAP(X_A));
                }
                return false;
            case KC_C: // Ç
                SEND_STRING(SS_LALT("c"));
                return false;
            case KC_W: // È
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("`") SS_DOWN(X_LSFT) SS_TAP(X_E) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("`") SS_TAP(X_E));
                }
                return false;
            case KC_E: // É
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("e") SS_DOWN(X_LSFT) SS_TAP(X_E) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("e") SS_TAP(X_E));
                }
                return false;
            case KC_R: // Ê
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("i") SS_DOWN(X_LSFT) SS_TAP(X_E) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("i") SS_TAP(X_E));
                }
                return false;
            case KC_T: // €
                SEND_STRING(SS_DOWN(X_LSFT) SS_LALT("2") SS_UP(X_LSFT));
                return false;
            case KC_I: // Î
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("i") SS_DOWN(X_LSFT) SS_TAP(X_I) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("i") SS_TAP(X_I));
                }
                return false;
            case KC_O: // Ï
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("u") SS_DOWN(X_LSFT) SS_TAP(X_I) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("u") SS_TAP(X_I));
                }
                return false;
            case KC_U: // Ù
                if (check_and_reset_shift()) {
                    SEND_STRING(SS_LALT("`") SS_DOWN(X_LSFT) SS_TAP(X_U) SS_UP(X_LSFT));
                } else {
                    SEND_STRING(SS_LALT("`") SS_TAP(X_U));
                }
                return false;
        }
    }
    return true;
}

#ifdef RGBLIGHT_ENABLE
void keyboard_post_init_user(void) {
    rgblight_enable_noeeprom(); // Enables RGB, without saving settings
    rgblight_sethsv_noeeprom(HSV_WHITE);
    rgblight_mode_noeeprom(RGBLIGHT_MODE_STATIC_LIGHT);
}
#endif

#ifdef OLED_ENABLE
oled_rotation_t oled_init_user(oled_rotation_t rotation) {
    return OLED_ROTATION_180;
}

static void render_eprc_logo(void) {
    static const char PROGMEM eprc_logo[] = {
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,
        0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
        0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,
        0xff,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
        0x01,0x01,0x01,0x03,0xcf,0xfe,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0xff,0xff,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
        0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,0x06,
        0x06,0x06,0x06,0x06,0x06,0x03,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x1f,0x1f,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
        0x18,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x1f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0xf0,0xf0,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,
        0x30,0x30,0x60,0xe0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xc0,0xe0,0x60,0x30,0x30,0x30,
        0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x60,0xe0,0xc0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,
        0xc0,0xc0,0xc0,0xc0,0xe0,0xf9,0x3f,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0xf8,0xff,0x07,0x01,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0xff,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x3f,0x78,0xe0,0xc0,
        0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xc0,0xe0,0x78,0x38,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x01,0x01,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    };
    oled_write_raw_P(eprc_logo, sizeof(eprc_logo));
}

static void render_qmk_logo(void) {
    static const char PROGMEM qmk_logo[] = {
        0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87,0x88,0x89,0x8a,0x8b,0x8c,0x8d,0x8e,0x8f,0x90,0x91,0x92,0x93,0x94,
        0xa0,0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8,0xa9,0xaa,0xab,0xac,0xad,0xae,0xaf,0xb0,0xb1,0xb2,0xb3,0xb4,
        0xc0,0xc1,0xc2,0xc3,0xc4,0xc5,0xc6,0xc7,0xc8,0xc9,0xca,0xcb,0xcc,0xcd,0xce,0xcf,0xd0,0xd1,0xd2,0xd3,0xd4,0
    };

    oled_write_P(qmk_logo, false);
}

static void render_status(void) {
    // QMK Logo and version information
    render_qmk_logo();
    oled_write_P(PSTR("Kyria: EPRC rev1.0\n\n"), false);

    // Host Keyboard Layer Status
    oled_write_P(PSTR("Layer: "), false);
    switch (get_highest_layer(layer_state)) {
        case QWERTY:
            oled_write_P(PSTR("Qwerty\n"), false);
            break;
        case LOWER:
            oled_write_P(PSTR("Lower\n"), false);
            break;
        case RAISE:
            oled_write_P(PSTR("Raise\n"), false);
            break;
        case NAVIGATION:
            oled_write_P(PSTR("Navigation\n"), false);
            break;
        default:
            oled_write_P(PSTR("Undefined\n"), false);
    }
}

bool oled_task_user(void) {
    if (is_keyboard_master()) {
        render_status(); // Renders the current keyboard state
    } else {
        render_eprc_logo();
    }
    return false;
}
#endif